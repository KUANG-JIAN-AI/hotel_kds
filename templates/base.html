<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <title>ã‚¹ãƒãƒ¼ãƒˆå¨æˆ¿ KDS ã‚·ã‚¹ãƒ†ãƒ </title>
    <link href="{{ url_for('static', filename='tailwind.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet">
</head>

<body class="font-sans">
    <div class="flex min-h-screen">
        <!-- å·¦ä¾§èœå• -->
        <nav class="sidebar flex flex-col p-4">
            <h2 class="text-xl font-bold mb-4">ğŸ‘¨â€ğŸ³ å¨æˆ¿ KDS</h2>
            <a href="/" class="{% if request.path == '/' %}active{% endif %}">ãƒ›ãƒ¼ãƒ </a>
            <a href="/totals" class="{% if request.path == '/totals' %}active{% endif %}">çµ±è¨ˆ</a>
            <a href="/foods" class="{% if request.path == '/foods' %}active{% endif %}">é£Ÿå“ç®¡ç†</a>
            <a href="/chefs" class="{% if request.path == '/chefs' %}active{% endif %}">ç®¡ç†äºº</a>
        </nav>

        <!-- ä¸»ä½“éƒ¨åˆ†ï¼ˆå·¦ä¾§èœå• + å†…å®¹ï¼‰ -->
        <div class="flex flex-1 flex-col">
            <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
            <header class="fixed top-0 left-56 right-0 flex items-center justify-between p-4 shadow z-50">
                <div class="flex items-center gap-3">
                    <div class="bg-blue-600 p-2 rounded-lg">ğŸ‘¨â€ğŸ³</div>
                    <h1 class="text-2xl font-bold">ã‚¹ãƒãƒ¼ãƒˆå¨æˆ¿ KDS ã‚·ã‚¹ãƒ†ãƒ </h1>
                </div>

                <div class="relative">
                    <button id="userMenuButton" class="flex items-center space-x-2 rounded-lg px-3 py-1">
                        <img src="{{ url_for('static', filename='user.png') }}" alt="User" class="w-8 h-8 rounded-full">
                        <span id="chef-nickname">{{ session.get('nickname', 'æœªç™»å½•') }}</span>
                        <svg class="w-4 h-4 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>

                    <div id="userDropdown" class="hidden absolute right-0 mt-2 w-40 border rounded-lg shadow-lg z-50"
                        style="background-color: #334155;">
                        <a id="add-set" href="javascript:;"
                            class="block px-4 py-2 text-red-600 hover:bg-gray-100">è¨­å®š</a>
                        <hr>
                        <a href="/logout" class="block px-4 py-2 text-red-600 hover:bg-red-50">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a>
                    </div>
                </div>
            </header>

            <!-- ä¸»ä½“å†…å®¹ -->
            <main class="flex-1 p-6 mt-16">
                {% block content %}{% endblock %}
            </main>
        </div>
    </div>
    <!-- å¼¹çª— -->
    <div id="set-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
        <div class="bg-slate-700/80 backdrop-blur-md p-6 rounded-lg w-96 shadow-lg border border-slate-600/50">
            <h2 class="text-xl font-bold mb-4">è¨­å®š</h2>
            <form id="set-form" class="space-y-4">
                <div>
                    <label class="block text-slate-200 mb-1">åå‰</label>
                    <input type="text" id="nickname" class="modal-input" value="{{ session.get('nickname') }}"
                        placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
                </div>
                <div>
                    <label class="block text-slate-200 mb-1">å½“å‰å¯†ç </label>
                    <input type="password" id="password" class="modal-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div>
                    <label class="block text-slate-200 mb-1">æ–°å¯†ç </label>
                    <input type="password" id="new-password" class="modal-input" placeholder="æ–°ã—ã„ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
                </div>
                <div class="flex justify-end gap-2">
                    <button type="button" id="cancel-set" class="modal-btn modal-btn-cancel">å–æ¶ˆ</button>
                    <button type="submit" class="modal-btn modal-btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    {% block model %}{% endblock %}
    <script src="{{ url_for('static', filename='jquery-3.6.0.min.js') }}"></script>
    <script src="{{ url_for('static', filename='sweetalert2@11.js') }}"></script>
    <script src="{{ url_for('static', filename='index.js') }}"></script>
    {% block js %}{% endblock %}
    <script>
        const addSet = document.getElementById('add-set');
        const setModal = document.getElementById('set-modal');
        const cancelSet = document.getElementById('cancel-set');
        const setForm = document.getElementById('set-form');

        addSet.addEventListener('click', () => {
            setModal.classList.remove('hidden');
            setModal.classList.add('flex');
        });

        cancelSet.addEventListener('click', () => {
            setModal.classList.add('hidden');
            setModal.classList.remove('flex');
        });

        setForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const nickname = document.getElementById('nickname').value;
            const password = document.getElementById('password').value;
            const new_password = document.getElementById('new-password').value;

            // --------------------------
            // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
            fetch('/set_chef', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ nickname: nickname, password: password, new_password: new_password })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.redirect) {
                        window.location.href = data.redirect;
                    } else if (data.code === 200) {
                        // éšè—è¡¨å•
                        setModal.classList.add('hidden');
                        setModal.classList.remove('flex');
                        // æ›´æ–°å‰ç«¯æ˜¾ç¤ºæ˜µç§°ï¼ˆæ¯”å¦‚å¯¼èˆªæ ä¸Šï¼‰
                        document.getElementById("chef-nickname").textContent = data.nickname;

                        success_alert(data.msg);
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('è¯·æ±‚å¤±è´¥', err));
            // --------------------------
        });

        $(document).ready(function () {
            $('#userMenuButton').on('click', function () {
                $('#userDropdown').toggleClass('hidden');
            });

            // ç‚¹å‡»å¤–éƒ¨åŒºåŸŸå…³é—­èœå•
            $(document).on('click', function (e) {
                if (!$(e.target).closest('#userMenuButton, #userDropdown').length) {
                    $('#userDropdown').addClass('hidden');
                }
            });
        });
    </script>
</body>

</html>