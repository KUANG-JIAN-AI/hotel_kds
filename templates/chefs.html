{% extends "base.html" %}

{% block content %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">ğŸ‘¨â€ğŸ³ ç®¡ç†äºº</h1>
    <button id="add-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg">
        â• ç®¡ç†äººã‚’è¿½åŠ 
    </button>
</div>

<div class="overflow-x-auto">
    <table id="chef-table" class="min-w-full bg-slate-800 rounded-lg shadow-lg">
        <thead>
            <tr>
                <th class="text-left text-slate-200">ID</th>
                <th class="text-left text-slate-200">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</th>
                <th class="text-left text-slate-200">åå‰</th>
                <th class="text-left text-slate-200">è£œè¶³</th>
                <th class="text-left text-slate-200">çŠ¶æ…‹</th>
                <th class="text-left text-slate-200">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for chef in chefs %}
            <tr id="chef-row-{{ chef.id }}">
                <td class="text-slate-100">{{ chef.id }}</td>
                <td class="text-slate-100">{{ chef.username }}</td>
                <td class="text-slate-100">{{ chef.nickname }}</td>
                <td class="text-slate-100">{{ chef.advice }}</td>
                <td class="text-slate-100"><span
                        class="{% if chef.status == 1 %}status-normal{% else %}status-critical{% endif %}">{{
                        chef.status_text() }}</span></td>
                <td class="text-slate-100">
                    <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="editChef('{{ chef.id }}')">ç·¨é›†</button>
                    <button
                        class="bg-red-500 hover:bg-red-600 text-white font-semibold px-3 py-1 rounded-lg shadow ml-2"
                        onclick="deleteChef('{{ chef.id }}')">åˆ é™¤</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="6" class="text-slate-400 text-center">åˆ©ç”¨å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ã¯ã‚ã‚Šã¾ã›ã‚“</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}


{% block model %}
<!-- å¼¹çª— -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
    <div class="bg-slate-700/80 backdrop-blur-md p-6 rounded-lg w-96 shadow-lg border border-slate-600/50">
        <h2 class="text-xl font-bold mb-4">ç®¡ç†äººã‚’è¿½åŠ </h2>
        <form id="add-form" class="space-y-4">
            <div>
                <label class="block text-slate-200 mb-1">ã‚¢ã‚«ã‚¦ãƒ³ãƒˆ</label>
                <input type="text" id="chef-username" class="modal-input" placeholder="ã‚¢ã‚«ã‚¦ãƒ³ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                <input type="password" id="chef-password" class="modal-input" placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">åå‰</label>
                <input type="text" id="chef-nickname" class="modal-input" placeholder="åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">çŠ¶æ…‹</label>
                <select id="chef-status" class="modal-select" required>
                    <option value="1" selected>æ­£å¸¸</option>
                </select>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">è£œè¶³</label>
                <input type="text" id="chef-advice" class="modal-input" placeholder="è£œè¶³ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="cancel-btn" class="modal-btn modal-btn-cancel">å–æ¶ˆ</button>
                <button type="submit" class="modal-btn modal-btn-primary">è¿½åŠ </button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    const addBtn = document.getElementById('add-btn');
    const modal = document.getElementById('modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const addForm = document.getElementById('add-form');
    const tableBody = document.querySelector('#chef-table tbody');

    addBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    });

    cancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    addForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const username = document.getElementById('chef-username').value;
        const password = document.getElementById('chef-password').value;
        const nickname = document.getElementById('chef-nickname').value;
        const status = document.getElementById('chef-status').value;
        const advice = document.getElementById('chef-advice').value;

        // --------------------------
        // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
        fetch('/chef', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ username: username, password: password, nickname: nickname, status: status, advice: advice })
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    // éšè—è¡¨å•
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    addForm.reset();

                    success_alert(data.msg);
                    appendChefRow(data.data);  // âœ… åŠ¨æ€æ’å…¥åˆ°è¡¨æ ¼
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('è¯·æ±‚å¤±è´¥', err));
        // --------------------------
    });

    // âœ… åŠ¨æ€æ·»åŠ ä¸€è¡Œåˆ°è¡¨æ ¼
    function appendChefRow(chef) {
        const newRow = document.createElement("tr");
        newRow.id = `chef-row-${chef.id}`;
        newRow.innerHTML = `
            <td class="text-slate-100">${chef.id}</td>
            <td class="text-slate-100">${chef.username}</td>
            <td class="text-slate-100">${chef.nickname}</td>
            <td class="text-slate-100">${chef.advice}</td>
            <td class="text-slate-100"><span class="status-normal">${chef.status_text}</span></td>
            <td class="text-slate-100">
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 py-1 rounded-lg shadow" onclick="editChef(${chef.id})">ç¼–è¾‘</button>
                <button class="bg-red-500 hover:bg-red-600 text-white font-semibold px-3 py-1 rounded-lg shadow ml-2" onclick="deleteChef(${chef.id})">åˆ é™¤</button>
            </td>
        `;

        // åœ¨é¡¶éƒ¨æ’å…¥æ–°æ•°æ®ï¼ˆå¦‚æœä½ å¸Œæœ›æœ€æ–°çš„æ˜¾ç¤ºåœ¨æœ€ä¸Šé¢ï¼‰
        tableBody.prepend(newRow);
    }

    function editChef(id) {
        alert(id);
    }

    function deleteChef(id) {
        Swal.fire({
            title: "ç¡®å®šåˆ é™¤å—ï¼Ÿ",
            text: "åˆ é™¤åç”¨æˆ·å°†æ— æ³•ç™»å½•",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "ç¡®å®š",
            cancelButtonText: "å–æ¶ˆ",
        }).then((result) => {
            if (result.isConfirmed) {
                // --------------------------
                // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
                fetch('/del_chef', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ chef_id: id })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.redirect) {
                            window.location.href = data.redirect;
                        } else if (data.code === 200) {
                            success_alert(data.msg);
                        } else {
                            error_alert(data.msg);
                        }
                    })
                    .catch(err => console.error('è¯·æ±‚å¤±è´¥', err));
                // --------------------------
            }
        });
    }
</script>
{% endblock %}