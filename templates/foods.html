{% extends "base.html" %}

{% block content %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">ğŸ± é£Ÿå“ä¸€è¦§</h1>
    <button id="add-btn" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg">
        â• é£Ÿå“ã‚’è¿½åŠ 
    </button>
</div>

<div class="overflow-x-auto">
    <!-- ğŸ” æ¤œç´¢æ¬„ -->
    <div class="flex justify-between items-center mb-4">
        <form class="space-y-4" action="/foods" method="POST">
            <div class="relative bg-slate-800 p-2 rounded-lg">
                <input name="keyword" type="text" placeholder="åç§°ã§æ¤œç´¢â€¦" value="{{ keyword or '' }}"
                    class="pl-4 pr-4 py-2 rounded-lg placeholder-slate-400 focus:outline-none focus:ring-2 focus:ring-yellow-400 focus:bg-slate-600 shadow-sm transition duration-200"
                    style="background-color: #334155; color: #f1f5f9;">
                <button type="submit" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg">
                    æ¤œç´¢
                </button>
            </div>
        </form>
    </div>

    <table id="food-table" class="min-w-full bg-slate-800 rounded-lg shadow-lg">
        <thead>
            <tr>
                <th class="text-left text-slate-200">ID</th>
                <th class="text-left text-slate-200">åç§°</th>
                <th class="text-left text-slate-200">ã‚«ãƒ†ã‚´ãƒª</th>
                <th class="text-left text-slate-200">æœ€å¤§é‡</th>
                <th class="text-left text-slate-200">æ¶ˆè²»é‡ï¼ˆç§’ï¼‰</th>
                <th class="text-left text-slate-200">æ³¨æ„é–¾å€¤</th>
                <th class="text-left text-slate-200">å±é™ºé–¾å€¤</th>
                <th class="text-left text-slate-200">çŠ¶æ…‹</th>
                <th class="text-left text-slate-200">æ“ä½œ</th>
            </tr>
        </thead>
        <tbody>
            {% for food in foods %}
            <tr id="food-row-{{ food.id }}">
                <td class="text-slate-100">{{ food.id }}</td>
                <td class="text-slate-100">{{ food.name }}</td>
                <td class="text-slate-100">{{ food.category }}</td>
                <td class="text-slate-100">{{ food.weight }}</td>
                <td class="text-slate-100">{{ food.decay_rate }}</td>
                <td class="text-slate-100">{{ food.warning_threshold }}</td>
                <td class="text-slate-100">{{ food.critical_threshold }}</td>
                <td class="text-slate-100">
                    <span class="{% if food.status == 1 %}status-normal{% else %}status-critical{% endif %}">
                        {{ food.status_text() }}
                    </span>
                </td>
                <td class="text-slate-100">
                    {% if food.is_today %}
                    <button id="btn-del-{{ food.id }}"
                        class="bg-pink-500 hover:bg-pink-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="delToday('{{ food.id }}')">è§£é™¤</button>
                    <button id="btn-add-{{ food.id }}"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-3 py-1 rounded-lg shadow hidden"
                        onclick="addToday('{{ food.id }}')">è¿½åŠ </button>
                    {% else %}
                    <button id="btn-del-{{ food.id }}"
                        class="bg-pink-500 hover:bg-pink-600 text-white font-semibold px-3 py-1 rounded-lg shadow hidden"
                        onclick="delToday('{{ food.id }}')">è§£é™¤</button>
                    <button id="btn-add-{{ food.id }}"
                        class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="addToday('{{ food.id }}')">è¿½åŠ </button>
                    {% endif %}

                    <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="editFood('{{ food.id }}')">ç·¨é›†</button>
                    <button class="bg-red-500 hover:bg-red-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="deleteFood('{{ food.id }}')">å‰Šé™¤</button>
                </td>
            </tr>
            {% else %}
            <tr>
                <td colspan="9" class="text-slate-400 text-center">è¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>

    <div id="pagination-area">
        <!-- ğŸŒŸ ãƒšãƒ¼ã‚¸ãƒãƒ¼ã‚·ãƒ§ãƒ³ -->
        {% if pagination.pages >= 1 %}
        <nav class="flex justify-center items-center mt-6 space-x-2">
            {% if pagination.has_prev %}
            <a href="{{ url_for('foods', page=pagination.prev_num, keyword=keyword) }}"
                class="px-3 py-1 rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition">Â«</a>
            {% else %}
            <span class="px-3 py-1 rounded-lg bg-slate-900 text-slate-600 cursor-not-allowed">Â«</span>
            {% endif %}

            {% for p in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
            {% if p %}
            {% if p == pagination.page %}
            <span class="px-3 py-1 rounded-lg bg-yellow-500 text-white font-semibold shadow">{{ p }}</span>
            {% else %}
            <a href="{{ url_for('foods', page=p, keyword=keyword) }}"
                class="px-3 py-1 rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition">{{ p }}</a>
            {% endif %}
            {% else %}
            <span class="px-2 text-slate-500">â€¦</span>
            {% endif %}
            {% endfor %}

            {% if pagination.has_next %}
            <a href="{{ url_for('foods', page=pagination.next_num, keyword=keyword) }}"
                class="px-3 py-1 rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600 transition">Â»</a>
            {% else %}
            <span class="px-3 py-1 rounded-lg bg-slate-900 text-slate-600 cursor-not-allowed">Â»</span>
            {% endif %}
        </nav>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block model %}
<!-- ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
    <div class="modal-bg backdrop-blur-md p-6 rounded-lg w-96 shadow-lg border border-slate-600/50">
        <h2 class="text-xl font-bold mb-4">é£Ÿå“ã‚’è¿½åŠ </h2>
        <form id="add-form" class="space-y-4">
            <div>
                <label class="block text-slate-200 mb-1">åç§°</label>
                <input type="text" id="food-name" class="modal-input" placeholder="åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                <input type="text" id="food-category" class="modal-input" placeholder="ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">åˆ†é‡</label>
                <input type="number" id="food-weight" class="modal-input" placeholder="åˆ†é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">æ¯ç§’æ¶ˆè²»é‡</label>
                <input type="number" id="food-decay_rate" class="modal-input" placeholder="æ¯ç§’æ¶ˆè²»é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">è­¦å‘Šé–¾å€¤</label>
                <input type="number" id="food-warning_threshold" class="modal-input" placeholder="è­¦å‘Šé–¾å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                    required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">å±é™ºé–¾å€¤</label>
                <input type="number" id="food-critical_threshold" class="modal-input" placeholder="å±é™ºé–¾å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                    required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">çŠ¶æ…‹</label>
                <select id="food-status" class="modal-select" required>
                    <option value="1" selected>æ­£å¸¸</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <button type="button" id="cancel-btn" class="modal-btn modal-btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="modal-btn modal-btn-primary">è¿½åŠ </button>
            </div>
        </form>
    </div>
</div>

<!-- ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
<div id="edit-modal" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-60 z-50">
    <div class="modal-bg backdrop-blur-md p-6 rounded-lg w-96 shadow-lg border border-slate-600/50">
        <h2 class="text-xl font-bold mb-4">é£Ÿå“ã‚’ç·¨é›†</h2>
        <form id="edit-form" class="space-y-4">
            <div>
                <label class="block text-slate-200 mb-1">åç§°</label>
                <input type="text" id="edit-name" class="modal-input" placeholder="åç§°ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">ã‚«ãƒ†ã‚´ãƒª</label>
                <input type="text" id="edit-category" class="modal-input" placeholder="ã‚«ãƒ†ã‚´ãƒªã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">åˆ†é‡</label>
                <input type="number" id="edit-weight" class="modal-input" placeholder="åˆ†é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">æ¯ç§’æ¶ˆè²»é‡</label>
                <input type="number" id="edit-decay_rate" class="modal-input" placeholder="æ¯ç§’æ¶ˆè²»é‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">è­¦å‘Šé–¾å€¤</label>
                <input type="number" id="edit-warning_threshold" class="modal-input" placeholder="è­¦å‘Šé–¾å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                    required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">å±é™ºé–¾å€¤</label>
                <input type="number" id="edit-critical_threshold" class="modal-input" placeholder="å±é™ºé–¾å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"
                    required>
            </div>
            <div>
                <label class="block text-slate-200 mb-1">çŠ¶æ…‹</label>
                <select id="edit-status" class="modal-select" required>
                    <option value="1" selected>æ­£å¸¸</option>
                </select>
            </div>
            <div class="flex justify-end gap-2">
                <input type="hidden" id="edit-id">
                <button type="button" id="cancel-edit" class="modal-btn modal-btn-cancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="submit" class="modal-btn modal-btn-primary">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>
{% endblock %}

{% block js %}
<script>
    const addBtn = document.getElementById('add-btn');
    const modal = document.getElementById('modal');
    const cancelBtn = document.getElementById('cancel-btn');
    const addForm = document.getElementById('add-form');
    const tableBody = document.querySelector('#food-table tbody');

    // ç·¨é›†ã‚°ãƒ«ãƒ¼ãƒ—
    const editModal = document.getElementById('edit-modal');
    const cancelEdit = document.getElementById('cancel-edit');
    const editForm = document.getElementById('edit-form');

    cancelEdit.addEventListener('click', () => {
        editModal.classList.add('hidden');
        editModal.classList.remove('flex');
    });

    addBtn.addEventListener('click', () => {
        modal.classList.remove('hidden');
        modal.classList.add('flex');
    });

    cancelBtn.addEventListener('click', () => {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    });

    addForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const name = document.getElementById('food-name').value;
        const category = document.getElementById('food-category').value;
        const weight = document.getElementById('food-weight').value;
        const decay_rate = document.getElementById('food-decay_rate').value;
        const warning_threshold = document.getElementById('food-warning_threshold').value;
        const critical_threshold = document.getElementById('food-critical_threshold').value;
        const status = document.getElementById('food-status').value;

        // --------------------------
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetch('/food', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                category: category,
                weight: weight,
                decay_rate: decay_rate,
                warning_threshold: warning_threshold,
                critical_threshold: critical_threshold,
                status: status
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
                    modal.classList.add('hidden');
                    modal.classList.remove('flex');
                    addForm.reset();

                    success_alert(data.msg);
                    appendfoodRow(data.data);  // âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã«å‹•çš„è¿½åŠ 
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—', err));
        // --------------------------
    });

    editForm.addEventListener('submit', (e) => {
        e.preventDefault();
        const food_id = document.getElementById('edit-id').value;
        const name = document.getElementById('edit-name').value;
        const category = document.getElementById('edit-category').value;
        const weight = document.getElementById('edit-weight').value;
        const decay_rate = document.getElementById('edit-decay_rate').value;
        const warning_threshold = document.getElementById('edit-warning_threshold').value;
        const critical_threshold = document.getElementById('edit-critical_threshold').value;
        const status = document.getElementById('edit-status').value;

        // --------------------------
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetch('/food/' + food_id, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                name: name,
                category: category,
                weight: weight,
                decay_rate: decay_rate,
                warning_threshold: warning_threshold,
                critical_threshold: critical_threshold,
                status: status
            })
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    // ãƒ•ã‚©ãƒ¼ãƒ ã‚’éè¡¨ç¤º
                    editModal.classList.add('hidden');
                    editModal.classList.remove('flex');
                    editForm.reset();
                    addNotification("âœ… " + data.msg);
                    location.reload();
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—', err));
        // --------------------------
    });

    // âœ… ãƒ†ãƒ¼ãƒ–ãƒ«ã«1è¡Œè¿½åŠ 
    function appendfoodRow(food) {
        const newRow = document.createElement("tr");
        newRow.id = `food-row-${food.id}`;
        newRow.innerHTML = `
            <td class="text-slate-100">${food.id}</td>
            <td class="text-slate-100">${food.name}</td>
            <td class="text-slate-100">${food.category}</td>
            <td class="text-slate-100">${food.weight}</td>
            <td class="text-slate-100">${food.decay_rate}</td>
            <td class="text-slate-100">${food.warning_threshold}</td>
            <td class="text-slate-100">${food.critical_threshold}</td>
            <td class="text-slate-100"><span class="status-normal">${food.status_text}</span></td>
            <td class="text-slate-100">
                <button class="bg-yellow-500 hover:bg-yellow-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="addToday(${food.id})">æœ¬æ—¥å…¥åº«</button>
                <button class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="editFood(${food.id})">ç·¨é›†</button>
                <button class="bg-red-500 hover:bg-red-600 text-white font-semibold px-3 py-1 rounded-lg shadow"
                        onclick="deleteFood(${food.id})">å‰Šé™¤</button>
            </td>
        `;

        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ä¸Šã«è¡¨ç¤º
        tableBody.prepend(newRow);
    }

    function addToday(id) {
        // --------------------------
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetch('/add_today', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ food_id: id })
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    // âœ… ãƒœã‚¿ãƒ³çŠ¶æ…‹ã‚’åˆ‡ã‚Šæ›¿ãˆ
                    document.getElementById(`btn-add-${id}`).classList.add('hidden');
                    document.getElementById(`btn-del-${id}`).classList.remove('hidden');
                    addNotification("âœ… " + data.msg);
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—', err));
        // --------------------------
    }

    function delToday(id) {
        Swal.fire({
            title: "æœ¬å½“ã«ä¸‹æ¶ã—ã¾ã™ã‹ï¼Ÿ",
            text: "ä¸‹æ¶å¾Œã‚‚å†åº¦å…¥åº«ã§ãã¾ã™",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "ã¯ã„",
            cancelButtonText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
        }).then((result) => {
            if (result.isConfirmed) {
                // --------------------------
                fetch('/del_today', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ food_id: id })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.code === 200) {
                            document.getElementById(`btn-del-${id}`).classList.add('hidden');
                            document.getElementById(`btn-add-${id}`).classList.remove('hidden');
                            success_alert(data.msg);
                        } else {
                            error_alert(data.msg);
                        }
                    })
                    .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—', err));
                // --------------------------
            }
        });
    }

    function editFood(id) {
        editModal.classList.remove('hidden');
        editModal.classList.add('flex');
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
        fetch(`/food/${id}`)
            .then(res => res.json())
            .then(data => {
                document.getElementById("edit-id").value = data.data.id;
                document.getElementById("edit-name").value = data.data.name;
                document.getElementById("edit-category").value = data.data.category;
                document.getElementById("edit-weight").value = data.data.weight;
                document.getElementById("edit-decay_rate").value = data.data.decay_rate;
                document.getElementById("edit-warning_threshold").value = data.data.warning_threshold;
                document.getElementById("edit-critical_threshold").value = data.data.critical_threshold;
                document.getElementById("edit-status").value = data.data.status;
            })
            .catch(err => console.error("ç·¨é›†ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", err));
    }

    function deleteFood(id) {
        Swal.fire({
            title: "æœ¬å½“ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ",
            text: "å‰Šé™¤å¾Œã¯ä¸€è¦§ã«è¡¨ç¤ºã•ã‚Œã¾ã›ã‚“",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#3085d6",
            cancelButtonColor: "#d33",
            confirmButtonText: "å‰Šé™¤ã™ã‚‹",
            cancelButtonText: "ã‚­ãƒ£ãƒ³ã‚»ãƒ«",
        }).then((result) => {
            if (result.isConfirmed) {
                // --------------------------
                fetch('/del_food', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ food_id: id })
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.code === 200) {
                            addNotification("âœ… " + data.msg);
                            location.reload();
                        } else {
                            error_alert(data.msg);
                        }
                    })
                    .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆå¤±æ•—', err));
                // --------------------------
            }
        });
    }
</script>
{% endblock %}