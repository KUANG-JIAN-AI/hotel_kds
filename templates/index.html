{% extends "base.html" %}

{% block content %}
<header class="flex justify-between items-center p-4 rounded-xl border shadow-lg mb-6">
    <div class="flex items-center gap-3">
        <!-- <div class="bg-blue-600 p-2 rounded-lg">üë®‚Äçüç≥</div> -->
        <h1 class="text-2xl font-bold">üçΩÔ∏è ‰ªäÊó•„ÅÆÈ£ü‰∫ã</h1>
    </div>
    <div class="flex items-center gap-3">
        <div id="warning-count" class="px-3 py-2 rounded-lg bg-yellow-900/30 text-yellow-400">‚è∞ 0</div>
        <div id="critical-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-red-400">‚ö†Ô∏è 0</div>
        <div id="empty-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-yellow-400">‚ùå 0</div>
        <button id="toggle-btn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢</button>
    </div>
</header>

<div id="dishes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>

<div id="notifications" class="fixed bottom-6 right-6 space-y-2"></div>
{% endblock %}

{% block js %}

<script>
    const ICON = {
        alert: "‚ö†Ô∏è",
        check: "‚úÖ",
        clock: "‚è∞",
        refresh: "üîÑ",
        chef: "üë®‚Äçüç≥",
        bell: "üîî",
        spark: "‚ú®",
        close: "‚ùå",
        load: "üîÑ"
    };

    // const INITIAL_DISHES = [
    //     { id: 1, name: '„Ç™„Éº„Çπ„Éà„É©„É™„Ç¢Áî£„É≠„Éñ„Çπ„Çø„Éº', weight: 100, status: 'normal', decayRate: 0.8 },
    //     { id: 2, name: '„Éñ„É©„ÉÉ„ÇØ„Éö„ÉÉ„Éë„Éº„Éì„Éº„Éï', weight: 85, status: 'normal', decayRate: 1.2 },
    //     { id: 3, name: '„Éï„Ç©„Ç¢„Ç∞„É©', weight: 45, status: 'warning', decayRate: 1.5 },
    //     { id: 4, name: 'Êµ∑ÈÆÆ„ÉÅ„É£„Éº„Éè„É≥', weight: 90, status: 'normal', decayRate: 0.5 },
    //     { id: 5, name: '„ÉÜ„Ç£„É©„Éü„Çπ', weight: 20, status: 'critical', decayRate: 0.9 },
    //     { id: 6, name: '„Éú„É´„Ç∑„ÉÅ', weight: 60, status: 'normal', decayRate: 1.0 },
    //     { id: 7, name: '„Ç∑„Éº„Ç∂„Éº„Çµ„É©„ÉÄ', weight: 15, status: 'critical', decayRate: 0.7 },
    //     { id: 8, name: '„É©„É†„ÉÅ„Éß„ÉÉ„Éó', weight: 75, status: 'normal', decayRate: 1.1 },
    // ];

    // const WARNING_THRESHOLD = 40;
    // const CRITICAL_THRESHOLD = 20;

    // let dishes = [...INITIAL_DISHES];
    let refreshTimer = null; // ÂÆöÊó∂Âô®Âè•ÊüÑ
    let isRunning = true;    // ÂâçÁ´ØËøêË°åÁä∂ÊÄÅ
    // let intervalId = null;

    // function renderDishes() {
    //     const $grid = $("#dishes-grid");
    //     $grid.empty();

    //     dishes.forEach(dish => {
    //         let cardClass = "card-bg";
    //         let progressClass = "progress-normal";
    //         let statusText = "ÂçÅÂàÜ";
    //         let statusIcon = ICON.check;

    //         if (dish.status === "warning") {
    //             cardClass = "warning-bg";
    //             progressClass = "progress-warning";
    //             statusText = "Ë£úÂÖÖÊé®Â•®";
    //             statusIcon = ICON.clock;
    //         } else if (dish.status === "critical") {
    //             cardClass = "critical-bg";
    //             progressClass = "progress-critical";
    //             statusText = "Ëá≥ÊÄ•Ë£úÂÖÖ";
    //             statusIcon = ICON.alert;
    //         } else if (dish.status === "empty") {
    //             cardClass = "empty-bg";
    //             progressClass = "progress-empty";
    //             statusText = "Â£≤„ÇäÂàá„Çå";
    //             statusIcon = ICON.alert;
    //         }

    //         const $dish = $(`
    //       <div class="p-5 rounded-lg border-2 ${cardClass}">
    //         <h3 class="text-lg font-bold mb-2">${dish.name}</h3>
    //         <div class="h-3 w-full bg-slate-700 rounded-full overflow-hidden mb-3">
    //           <div class="${progressClass} h-full transition-all duration-500" style="width:${Math.round(dish.weight)}%"></div>
    //         </div>
    //         <div class="flex justify-between items-center">
    //           <div class="text-sm">${statusIcon} ${statusText}</div>
    //           <button class="bg-slate-700 px-3 py-1 rounded-lg hover:bg-blue-600 refill-btn" data-id="${dish.id}">${ICON.refresh}</button>
    //         </div>
    //       </div>
    //     `);
    //         $grid.append($dish);
    //     });

    //     const criticalCount = dishes.filter(d => d.status === "critical" || d.status === "empty").length;
    //     const warningCount = dishes.filter(d => d.status === "warning").length;
    //     $("#critical-count").text(`${ICON.alert} ${criticalCount}`);
    //     $("#warning-count").text(`${ICON.clock} ${warningCount}`);
    // }

    function addNotification(msg) {
        const $note = $(`<div class="bg-slate-800 border border-slate-600 px-4 py-2 rounded-lg shadow">${msg}</div>`);
        $("#notifications").prepend($note);
        setTimeout(() => $note.remove(), 3000);
    }

    // function decayDishes() {
    //     dishes = dishes.map(d => {
    //         if (d.weight <= 0) return { ...d, weight: 0, status: "empty" };
    //         const change = Math.random() * d.decayRate;
    //         const newWeight = Math.max(0, d.weight - change);
    //         let status = "normal";
    //         if (newWeight <= 0) status = "empty";
    //         else if (newWeight <= CRITICAL_THRESHOLD) status = "critical";
    //         else if (newWeight <= WARNING_THRESHOLD) status = "warning";
    //         return { ...d, weight: newWeight, status };
    //     });
    //     renderDishes();
    // }

    // function startInterval() {
    //     if (intervalId) clearInterval(intervalId);
    //     if (isRunning) {
    //         intervalId = setInterval(decayDishes, 1000);
    //     }
    // }

    function startAutoRefresh() {
        // ÈÅøÂÖçÈáçÂ§çÂÆöÊó∂Âô®
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(loadDishes, 1000);
        console.log("‚úÖ ÂâçÁ´ØÂà∑Êñ∞ÂêØÂä®");
    }

    function stopAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
            console.log("‚è∏ ÂâçÁ´ØÂà∑Êñ∞ÂÅúÊ≠¢");
        }
    }

    $(document).ready(function () {
        loadDishes();
        startAutoRefresh();

        $("#toggle-btn").click(function () {
            isRunning = !isRunning;
            // --------------------------
            // ÂèëÈÄÅ AJAX ËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
            fetch('/toggle_decay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_running: isRunning })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        if (data.status === "paused") {
                            $(this).text("‚ñ∂Ô∏è ÂÜçÈñã");
                            stopAutoRefresh();  // ‚úÖ ÂÅúÊ≠¢ÂâçÁ´ØÂà∑Êñ∞
                            isRunning = false;
                        } else {
                            $(this).text("‚è∏Ô∏è ‰∏ÄÊôÇÂÅúÊ≠¢");
                            startAutoRefresh(); // ‚úÖ ÊÅ¢Â§çÂâçÁ´ØÂà∑Êñ∞
                            isRunning = true;
                        }
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('ËØ∑Ê±ÇÂ§±Ë¥•', err));
            // --------------------------

        });

        $(document).on("click", ".refill-btn", function () {
            const id = parseInt($(this).data("id"));
            // --------------------------
            // ÂèëÈÄÅ AJAX ËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
            fetch('/append_today_food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ today_id: id })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        addNotification("‚úÖ Ë£úÂÖÖÂÆå‰∫Ü");
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('ËØ∑Ê±ÇÂ§±Ë¥•', err));
            // --------------------------
        });

    });

    function loadDishes() {
        // --------------------------
        // ÂèëÈÄÅ AJAX ËØ∑Ê±ÇÂà∞ÂêéÁ´Ø
        fetch('/today_foods', {
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    $("#warning-count").text(`${ICON.clock} ${data.stats.warning || 0}`);
                    $("#critical-count").text(`${ICON.alert} ${data.stats.critical || 0}`);
                    $("#empty-count").text(`${ICON.close} ${data.stats.empty || 0}`);

                    const $grid = $("#dishes-grid");
                    $grid.empty();

                    data.data.forEach(d => {
                        const f = d.food_info || {};
                        let cardClass = "card-bg";
                        let progressClass = "progress-normal";
                        let statusText = "ÂçÅÂàÜ";
                        let statusIcon = ICON.check;

                        if (d.remain == 1) {
                            cardClass = "warning-bg";
                            progressClass = "progress-warning";
                            statusText = "Ë£úÂÖÖÊé®Â•®";
                            statusIcon = ICON.clock;
                        } else if (d.remain == 2) {
                            cardClass = "critical-bg";
                            progressClass = "progress-critical";
                            statusText = "Ëá≥ÊÄ•Ë£úÂÖÖ";
                            statusIcon = ICON.alert;
                        } else if (d.remain == 3) {
                            cardClass = "empty-bg";
                            progressClass = "progress-empty";
                            statusText = "Â£≤„ÇäÂàá„Çå";
                            statusIcon = ICON.close;
                        }

                        const $dish = $(`
                        <div class="p-5 rounded-lg border-2 ${cardClass}">
                            <h3 class="text-lg font-bold mb-2">${f.name}</h3>
                            <div class="h-3 w-full bg-slate-700 rounded-full overflow-hidden mb-3">
                            <div class="${progressClass} h-full transition-all duration-500" style="width:${Math.round(d.current_weight)}%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                            <div class="text-sm">${statusIcon} ${statusText}</div>
                            <button class="bg-slate-700 px-3 py-1 rounded-lg hover:bg-blue-600 refill-btn" data-id="${d.id}">${ICON.refresh}</button>
                            </div>
                        </div>
                        `);
                        $grid.append($dish);
                    });
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('ËØ∑Ê±ÇÂ§±Ë¥•', err));
        // --------------------------
    }
</script>
{% endblock %}