{% extends "base.html" %}

{% block content %}
<header class="flex justify-between items-center p-4 rounded-xl border shadow-lg mb-6">
    <div class="flex items-center gap-3">
        <!-- <div class="bg-blue-600 p-2 rounded-lg">ğŸ‘¨â€ğŸ³</div> -->
        <h1 class="text-2xl font-bold">ğŸ½ï¸ æœ¬æ—¥ã®æ–™ç†</h1>
    </div>
    <div class="flex items-center gap-3">
        <div id="warning-count" class="px-3 py-2 rounded-lg bg-yellow-900/30 text-yellow-400">â° 0</div>
        <div id="critical-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-red-400">âš ï¸ 0</div>
        <div id="empty-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-yellow-400">âŒ 0</div>
        <button id="toggle-btn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
    </div>
</header>

<div id="dishes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
{% endblock %}

{% block js %}

<script>
    const ICON = {
        alert: "âš ï¸",
        check: "âœ…",
        clock: "â°",
        refresh: "ğŸ”„",
        chef: "ğŸ‘¨â€ğŸ³",
        bell: "ğŸ””",
        spark: "âœ¨",
        close: "âŒ",
        load: "ğŸ”„"
    };

    let refreshTimer = null; // ã‚¿ã‚¤ãƒãƒ¼ã®ãƒãƒ³ãƒ‰ãƒ«
    let isRunning = true;    // ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®ç¨¼åƒçŠ¶æ…‹

    function startAutoRefresh() {
        // ã‚¿ã‚¤ãƒãƒ¼ã®é‡è¤‡ã‚’é˜²æ­¢
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(loadDishes, 1000);
        console.log("âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°ã‚’é–‹å§‹");
    }

    function stopAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
            console.log("â¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°ã‚’åœæ­¢");
        }
    }

    $(document).ready(function () {
        loadDishes();
        startAutoRefresh();

        $("#toggle-btn").click(function () {
            isRunning = !isRunning;
            // --------------------------
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            fetch('/toggle_decay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_running: isRunning })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        if (data.status === "paused") {
                            $(this).text("â–¶ï¸ å†é–‹");
                            stopAutoRefresh();  // âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°ã‚’åœæ­¢
                            isRunning = false;
                        } else {
                            $(this).text("â¸ï¸ ä¸€æ™‚åœæ­¢");
                            startAutoRefresh(); // âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°ã‚’å†é–‹
                            isRunning = true;
                        }
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', err));
            // --------------------------

        });

        $(document).on("click", ".refill-btn", function () {
            const id = parseInt($(this).data("id"));
            // --------------------------
            // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
            fetch('/append_today_food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ today_id: id })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        addNotification("âœ… è£œå……ãŒå®Œäº†ã—ã¾ã—ãŸ");
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', err));
            // --------------------------
        });

    });

    function loadDishes() {
        // --------------------------
        // ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ AJAX ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        fetch('/today_foods', {
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    $("#warning-count").text(`${ICON.clock} ${data.stats.warning || 0}`);
                    $("#critical-count").text(`${ICON.alert} ${data.stats.critical || 0}`);
                    $("#empty-count").text(`${ICON.close} ${data.stats.empty || 0}`);

                    if (data.decay_status == "paused") {
                        $("#toggle-btn").text("â–¶ï¸ å†é–‹");
                        stopAutoRefresh();  // âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°ã‚’åœæ­¢
                        isRunning = false;
                    } else {
                        $("#toggle-btn").text("â¸ï¸ ä¸€æ™‚åœæ­¢");
                        startAutoRefresh(); // âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®æ›´æ–°ã‚’å†é–‹
                        isRunning = true;
                    }

                    const $grid = $("#dishes-grid");
                    $grid.empty();

                    data.data.forEach(d => {
                        const f = d.food_info || {};
                        let cardClass = "card-bg";
                        let progressClass = "progress-normal";
                        let statusText = "ååˆ†";
                        let statusIcon = ICON.check;

                        if (d.remain == 1) {
                            cardClass = "warning-bg";
                            progressClass = "progress-warning";
                            statusText = "è£œå……æ¨å¥¨";
                            statusIcon = ICON.clock;
                        } else if (d.remain == 2) {
                            cardClass = "critical-bg";
                            progressClass = "progress-critical";
                            statusText = "è‡³æ€¥è£œå……";
                            statusIcon = ICON.alert;
                        } else if (d.remain == 3) {
                            cardClass = "empty-bg";
                            progressClass = "progress-empty";
                            statusText = "å£²ã‚Šåˆ‡ã‚Œ";
                            statusIcon = ICON.close;
                        }

                        const $dish = $(`
                        <div class="p-5 rounded-lg border-2 ${cardClass}">
                            <h3 class="text-lg font-bold mb-2">${f.name}</h3>
                            <div class="h-3 w-full bg-slate-700 rounded-full overflow-hidden mb-3">
                            <div class="${progressClass} h-full transition-all duration-500" style="width:${Math.round(d.current_weight)}%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                            <div class="text-sm">${statusIcon} ${statusText}</div>
                            <button class="bg-slate-700 px-3 py-1 rounded-lg hover:bg-blue-600 refill-btn" data-id="${d.id}">${ICON.refresh}</button>
                            </div>
                        </div>
                        `);
                        $grid.append($dish);
                    });
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«å¤±æ•—ã—ã¾ã—ãŸ', err));
        // --------------------------
    }
</script>
{% endblock %}