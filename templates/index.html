{% extends "base.html" %}

{% block content %}
<header class="flex justify-between items-center p-4 rounded-xl border shadow-lg mb-6">
    <div class="flex items-center gap-3">
        <!-- <div class="bg-blue-600 p-2 rounded-lg">ğŸ‘¨â€ğŸ³</div> -->
        <h1 class="text-2xl font-bold">ğŸ½ï¸ ä»Šæ—¥ã®é£Ÿäº‹</h1>
    </div>
    <div class="flex items-center gap-3">
        <div id="warning-count" class="px-3 py-2 rounded-lg bg-yellow-900/30 text-yellow-400">â° 0</div>
        <div id="critical-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-red-400">âš ï¸ 0</div>
        <div id="empty-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-yellow-400">âŒ 0</div>
        <button id="toggle-btn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">â¸ï¸ ä¸€æ™‚åœæ­¢</button>
    </div>
</header>

<div id="dishes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
{% endblock %}

{% block js %}

<script>
    const ICON = {
        alert: "âš ï¸",
        check: "âœ…",
        clock: "â°",
        refresh: "ğŸ”„",
        chef: "ğŸ‘¨â€ğŸ³",
        bell: "ğŸ””",
        spark: "âœ¨",
        close: "âŒ",
        load: "ğŸ”„"
    };

    // const INITIAL_DISHES = [
    //     { id: 1, name: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢ç”£ãƒ­ãƒ–ã‚¹ã‚¿ãƒ¼', weight: 100, status: 'normal', decayRate: 0.8 },
    //     { id: 2, name: 'ãƒ–ãƒ©ãƒƒã‚¯ãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¼ãƒ•', weight: 85, status: 'normal', decayRate: 1.2 },
    //     { id: 3, name: 'ãƒ•ã‚©ã‚¢ã‚°ãƒ©', weight: 45, status: 'warning', decayRate: 1.5 },
    //     { id: 4, name: 'æµ·é®®ãƒãƒ£ãƒ¼ãƒãƒ³', weight: 90, status: 'normal', decayRate: 0.5 },
    //     { id: 5, name: 'ãƒ†ã‚£ãƒ©ãƒŸã‚¹', weight: 20, status: 'critical', decayRate: 0.9 },
    //     { id: 6, name: 'ãƒœãƒ«ã‚·ãƒ', weight: 60, status: 'normal', decayRate: 1.0 },
    //     { id: 7, name: 'ã‚·ãƒ¼ã‚¶ãƒ¼ã‚µãƒ©ãƒ€', weight: 15, status: 'critical', decayRate: 0.7 },
    //     { id: 8, name: 'ãƒ©ãƒ ãƒãƒ§ãƒƒãƒ—', weight: 75, status: 'normal', decayRate: 1.1 },
    // ];

    // const WARNING_THRESHOLD = 40;
    // const CRITICAL_THRESHOLD = 20;

    // let dishes = [...INITIAL_DISHES];
    let refreshTimer = null; // å®šæ—¶å™¨å¥æŸ„
    let isRunning = true;    // å‰ç«¯è¿è¡ŒçŠ¶æ€
    // let intervalId = null;

    // function renderDishes() {
    //     const $grid = $("#dishes-grid");
    //     $grid.empty();

    //     dishes.forEach(dish => {
    //         let cardClass = "card-bg";
    //         let progressClass = "progress-normal";
    //         let statusText = "ååˆ†";
    //         let statusIcon = ICON.check;

    //         if (dish.status === "warning") {
    //             cardClass = "warning-bg";
    //             progressClass = "progress-warning";
    //             statusText = "è£œå……æ¨å¥¨";
    //             statusIcon = ICON.clock;
    //         } else if (dish.status === "critical") {
    //             cardClass = "critical-bg";
    //             progressClass = "progress-critical";
    //             statusText = "è‡³æ€¥è£œå……";
    //             statusIcon = ICON.alert;
    //         } else if (dish.status === "empty") {
    //             cardClass = "empty-bg";
    //             progressClass = "progress-empty";
    //             statusText = "å£²ã‚Šåˆ‡ã‚Œ";
    //             statusIcon = ICON.alert;
    //         }

    //         const $dish = $(`
    //       <div class="p-5 rounded-lg border-2 ${cardClass}">
    //         <h3 class="text-lg font-bold mb-2">${dish.name}</h3>
    //         <div class="h-3 w-full bg-slate-700 rounded-full overflow-hidden mb-3">
    //           <div class="${progressClass} h-full transition-all duration-500" style="width:${Math.round(dish.weight)}%"></div>
    //         </div>
    //         <div class="flex justify-between items-center">
    //           <div class="text-sm">${statusIcon} ${statusText}</div>
    //           <button class="bg-slate-700 px-3 py-1 rounded-lg hover:bg-blue-600 refill-btn" data-id="${dish.id}">${ICON.refresh}</button>
    //         </div>
    //       </div>
    //     `);
    //         $grid.append($dish);
    //     });

    //     const criticalCount = dishes.filter(d => d.status === "critical" || d.status === "empty").length;
    //     const warningCount = dishes.filter(d => d.status === "warning").length;
    //     $("#critical-count").text(`${ICON.alert} ${criticalCount}`);
    //     $("#warning-count").text(`${ICON.clock} ${warningCount}`);
    // }



    // function decayDishes() {
    //     dishes = dishes.map(d => {
    //         if (d.weight <= 0) return { ...d, weight: 0, status: "empty" };
    //         const change = Math.random() * d.decayRate;
    //         const newWeight = Math.max(0, d.weight - change);
    //         let status = "normal";
    //         if (newWeight <= 0) status = "empty";
    //         else if (newWeight <= CRITICAL_THRESHOLD) status = "critical";
    //         else if (newWeight <= WARNING_THRESHOLD) status = "warning";
    //         return { ...d, weight: newWeight, status };
    //     });
    //     renderDishes();
    // }

    // function startInterval() {
    //     if (intervalId) clearInterval(intervalId);
    //     if (isRunning) {
    //         intervalId = setInterval(decayDishes, 1000);
    //     }
    // }

    function startAutoRefresh() {
        // é¿å…é‡å¤å®šæ—¶å™¨
        if (refreshTimer) clearInterval(refreshTimer);
        refreshTimer = setInterval(loadDishes, 1000);
        console.log("âœ… å‰ç«¯åˆ·æ–°å¯åŠ¨");
    }

    function stopAutoRefresh() {
        if (refreshTimer) {
            clearInterval(refreshTimer);
            refreshTimer = null;
            console.log("â¸ å‰ç«¯åˆ·æ–°åœæ­¢");
        }
    }

    $(document).ready(function () {
        loadDishes();
        startAutoRefresh();

        $("#toggle-btn").click(function () {
            isRunning = !isRunning;
            // --------------------------
            // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
            fetch('/toggle_decay', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_running: isRunning })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        if (data.status === "paused") {
                            $(this).text("â–¶ï¸ å†é–‹");
                            stopAutoRefresh();  // âœ… åœæ­¢å‰ç«¯åˆ·æ–°
                            isRunning = false;
                        } else {
                            $(this).text("â¸ï¸ ä¸€æ™‚åœæ­¢");
                            startAutoRefresh(); // âœ… æ¢å¤å‰ç«¯åˆ·æ–°
                            isRunning = true;
                        }
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('è¯·æ±‚å¤±è´¥', err));
            // --------------------------

        });

        $(document).on("click", ".refill-btn", function () {
            const id = parseInt($(this).data("id"));
            // --------------------------
            // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
            fetch('/append_today_food', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ today_id: id })
            })
                .then(res => res.json())
                .then(data => {
                    if (data.code === 200) {
                        addNotification("âœ… è£œå……å®Œäº†");
                    } else {
                        error_alert(data.msg);
                    }
                })
                .catch(err => console.error('è¯·æ±‚å¤±è´¥', err));
            // --------------------------
        });

    });

    function loadDishes() {
        // --------------------------
        // å‘é€ AJAX è¯·æ±‚åˆ°åç«¯
        fetch('/today_foods', {
            headers: {
                'Content-Type': 'application/json'
            },
        })
            .then(res => res.json())
            .then(data => {
                if (data.code === 200) {
                    $("#warning-count").text(`${ICON.clock} ${data.stats.warning || 0}`);
                    $("#critical-count").text(`${ICON.alert} ${data.stats.critical || 0}`);
                    $("#empty-count").text(`${ICON.close} ${data.stats.empty || 0}`);

                    const $grid = $("#dishes-grid");
                    $grid.empty();

                    data.data.forEach(d => {
                        const f = d.food_info || {};
                        let cardClass = "card-bg";
                        let progressClass = "progress-normal";
                        let statusText = "ååˆ†";
                        let statusIcon = ICON.check;

                        if (d.remain == 1) {
                            cardClass = "warning-bg";
                            progressClass = "progress-warning";
                            statusText = "è£œå……æ¨å¥¨";
                            statusIcon = ICON.clock;
                        } else if (d.remain == 2) {
                            cardClass = "critical-bg";
                            progressClass = "progress-critical";
                            statusText = "è‡³æ€¥è£œå……";
                            statusIcon = ICON.alert;
                        } else if (d.remain == 3) {
                            cardClass = "empty-bg";
                            progressClass = "progress-empty";
                            statusText = "å£²ã‚Šåˆ‡ã‚Œ";
                            statusIcon = ICON.close;
                        }

                        const $dish = $(`
                        <div class="p-5 rounded-lg border-2 ${cardClass}">
                            <h3 class="text-lg font-bold mb-2">${f.name}</h3>
                            <div class="h-3 w-full bg-slate-700 rounded-full overflow-hidden mb-3">
                            <div class="${progressClass} h-full transition-all duration-500" style="width:${Math.round(d.current_weight)}%"></div>
                            </div>
                            <div class="flex justify-between items-center">
                            <div class="text-sm">${statusIcon} ${statusText}</div>
                            <button class="bg-slate-700 px-3 py-1 rounded-lg hover:bg-blue-600 refill-btn" data-id="${d.id}">${ICON.refresh}</button>
                            </div>
                        </div>
                        `);
                        $grid.append($dish);
                    });
                } else {
                    error_alert(data.msg);
                }
            })
            .catch(err => console.error('è¯·æ±‚å¤±è´¥', err));
        // --------------------------
    }
</script>
{% endblock %}