{% extends "base.html" %}

{% block content %}
<header class="flex justify-between items-center p-4 rounded-xl border shadow-lg mb-6">
    <div class="flex items-center gap-3">
        <div class="bg-blue-600 p-2 rounded-lg">ğŸ‘¨â€ğŸ³</div>
        <h1 class="text-2xl font-bold">ã‚¹ãƒãƒ¼ãƒˆå¨æˆ¿ KDS ã‚·ã‚¹ãƒ†ãƒ </h1>
    </div>
    <div class="flex items-center gap-3">
        <div id="critical-count" class="px-3 py-2 rounded-lg bg-red-900/30 text-red-400">âš ï¸ 0</div>
        <div id="warning-count" class="px-3 py-2 rounded-lg bg-yellow-900/30 text-yellow-400">ğŸ”” 0</div>
        <button id="toggle-btn" class="px-4 py-2 rounded-lg bg-slate-700 hover:bg-slate-600">ä¸€æ™‚åœæ­¢</button>
    </div>
</header>

<div id="dishes-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>

<div id="notifications" class="fixed bottom-6 right-6 space-y-2"></div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='jquery-3.6.0.min.js') }}"></script>

<script>
    const ICON = {
        alert: "âš ï¸",
        check: "âœ…",
        clock: "â°",
        refresh: "ğŸ”„"
    };

    const INITIAL_DISHES = [
        { id: 1, name: 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢ç”£ãƒ­ãƒ–ã‚¹ã‚¿ãƒ¼', weight: 100, status: 'normal', decayRate: 0.8 },
        { id: 2, name: 'ãƒ–ãƒ©ãƒƒã‚¯ãƒšãƒƒãƒ‘ãƒ¼ãƒ“ãƒ¼ãƒ•', weight: 85, status: 'normal', decayRate: 1.2 },
        { id: 3, name: 'ãƒ•ã‚©ã‚¢ã‚°ãƒ©', weight: 45, status: 'warning', decayRate: 1.5 },
        { id: 4, name: 'æµ·é®®ãƒãƒ£ãƒ¼ãƒãƒ³', weight: 90, status: 'normal', decayRate: 0.5 },
        { id: 5, name: 'ãƒ†ã‚£ãƒ©ãƒŸã‚¹', weight: 20, status: 'critical', decayRate: 0.9 },
        { id: 6, name: 'ãƒœãƒ«ã‚·ãƒ', weight: 60, status: 'normal', decayRate: 1.0 },
        { id: 7, name: 'ã‚·ãƒ¼ã‚¶ãƒ¼ã‚µãƒ©ãƒ€', weight: 15, status: 'critical', decayRate: 0.7 },
        { id: 8, name: 'ãƒ©ãƒ ãƒãƒ§ãƒƒãƒ—', weight: 75, status: 'normal', decayRate: 1.1 },
    ];

    const WARNING_THRESHOLD = 40;
    const CRITICAL_THRESHOLD = 20;

    let dishes = [...INITIAL_DISHES];
    let isRunning = true;
    let intervalId = null;

    function renderDishes() {
        const $grid = $("#dishes-grid");
        $grid.empty();

        dishes.forEach(dish => {
            let cardClass = "card-bg";
            let progressClass = "progress-normal";
            let statusText = "ååˆ†";
            let statusIcon = ICON.check;

            if (dish.status === "warning") {
                cardClass = "warning-bg";
                progressClass = "progress-warning";
                statusText = "è£œå……æ¨å¥¨";
                statusIcon = ICON.clock;
            } else if (dish.status === "critical") {
                cardClass = "critical-bg";
                progressClass = "progress-critical";
                statusText = "è‡³æ€¥è£œå……";
                statusIcon = ICON.alert;
            } else if (dish.status === "empty") {
                cardClass = "empty-bg";
                progressClass = "progress-empty";
                statusText = "å£²ã‚Šåˆ‡ã‚Œ";
                statusIcon = ICON.alert;
            }

            const $dish = $(`
          <div class="p-5 rounded-lg border-2 ${cardClass}">
            <h3 class="text-lg font-bold mb-2">${dish.name}</h3>
            <div class="h-3 w-full bg-slate-700 rounded-full overflow-hidden mb-3">
              <div class="${progressClass} h-full transition-all duration-500" style="width:${Math.round(dish.weight)}%"></div>
            </div>
            <div class="flex justify-between items-center">
              <div class="text-sm">${statusIcon} ${statusText}</div>
              <button class="bg-slate-700 px-3 py-1 rounded-lg hover:bg-blue-600 refill-btn" data-id="${dish.id}">${ICON.refresh}</button>
            </div>
          </div>
        `);
            $grid.append($dish);
        });

        const criticalCount = dishes.filter(d => d.status === "critical" || d.status === "empty").length;
        const warningCount = dishes.filter(d => d.status === "warning").length;
        $("#critical-count").text(`${ICON.alert} ${criticalCount}`);
        $("#warning-count").text(`${ICON.clock} ${warningCount}`);
    }

    function addNotification(msg) {
        const $note = $(`<div class="bg-slate-800 border border-slate-600 px-4 py-2 rounded-lg shadow">${msg}</div>`);
        $("#notifications").prepend($note);
        setTimeout(() => $note.remove(), 3000);
    }

    function decayDishes() {
        dishes = dishes.map(d => {
            if (d.weight <= 0) return { ...d, weight: 0, status: "empty" };
            const change = Math.random() * d.decayRate;
            const newWeight = Math.max(0, d.weight - change);
            let status = "normal";
            if (newWeight <= 0) status = "empty";
            else if (newWeight <= CRITICAL_THRESHOLD) status = "critical";
            else if (newWeight <= WARNING_THRESHOLD) status = "warning";
            return { ...d, weight: newWeight, status };
        });
        renderDishes();
    }

    function startInterval() {
        if (intervalId) clearInterval(intervalId);
        if (isRunning) {
            intervalId = setInterval(decayDishes, 1000);
        }
    }

    $(document).ready(function () {
        renderDishes();
        startInterval();

        $("#toggle-btn").click(function () {
            isRunning = !isRunning;
            $(this).text(isRunning ? "ä¸€æ™‚åœæ­¢" : "å†é–‹");
            startInterval();
        });

        $(document).on("click", ".refill-btn", function () {
            const id = parseInt($(this).data("id"));
            dishes = dishes.map(d => d.id === id ? { ...d, weight: 100, status: "normal" } : d);
            renderDishes();
            addNotification("âœ… è£œå……å®Œäº†");
        });
    });
</script>
{% endblock %}