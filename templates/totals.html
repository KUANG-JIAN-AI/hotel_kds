{% extends "base.html" %}

{% block content %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">ğŸ“Š ç›´è¿‘30æ—¥é–“ã®é£Ÿæçµ±è¨ˆ</h1>

    <div class="space-x-2">
        <button id="toggleChartTypeBtn"
            class="bg-gray-700 hover:bg-gray-600 text-gray-100 px-4 py-2 rounded-md transition">
            æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã«åˆ‡ã‚Šæ›¿ãˆ
        </button>
    </div>
</div>

<div class="overflow-x-auto">
    <div class="bg-gray-800 p-4 rounded-2xl shadow-md min-h-[calc(100vh-120px)]">
        <canvas id="dailyChart" class="w-full h-full"></canvas>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='chart.js') }}"></script>
<script>
$(function () {
    const chartData = {{ data|default({})|tojson }};
    const allFoods = {{ foods|default([])|tojson }};
    const labels = Object.keys(chartData);

    // ğŸ¨ æ ¹æ®é£Ÿæåç”Ÿæˆç¨³å®šé¢œè‰²ï¼ˆå›ºå®šä¸”åŒºåˆ†æ˜æ˜¾ï¼‰
    const getColorByName = (name) => {
        let hash = 0;
        for (let i = 0; i < name.length; i++) {
            // ä½¿ç”¨ç¨å¾®å¤æ‚çš„å“ˆå¸Œè®¡ç®—
            hash = name.charCodeAt(i) + ((hash << 5) - hash);
            hash = hash & hash; // è½¬æ¢ä¸º32ä½æ•´æ•°
        }

        // 1. ä½¿ç”¨é»„é‡‘åˆ†å‰²ç‡ (çº¦ 0.618) åˆ†æ•£è‰²ç›¸ï¼Œé¿å…ç›¸é‚»é¢œè‰²å¤ªæ¥è¿‘
        const goldenRatioConjugate = 0.618033988749895;
        let h = Math.abs(hash) * goldenRatioConjugate;
        const hue = (h % 1) * 360;

        // 2. æ ¹æ®å“ˆå¸Œå€¼äº¤æ›¿æ”¹å˜æ˜åº¦ (45% - 65%)ï¼Œè¿›ä¸€æ­¥å¢åŠ åŒºåˆ†åº¦
        // è¿™æ ·å³ä½¿é¢œè‰²æ¥è¿‘ï¼Œä¸€ä¸ªæ·±ä¸€ä¸ªæµ…ä¹Ÿèƒ½åˆ†å¾—å¼€
        const lightness = 45 + (Math.abs(hash) % 20); 
        
        // 3. ä¿æŒä¸­é«˜é¥±å’Œåº¦
        const saturation = 65 + (Math.abs(hash) % 15);

        return `hsl(${hue}, ${saturation}%, ${lightness}%)`;
    };
    // ğŸ”¹ å…¨ã¦ã®æ–™ç†ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ä½œæˆ
    const fullDatasets = allFoods.map(food => {
        const dataPoints = labels.map(date => chartData[date][food] || 0);
        return {
            label: food,
            data: dataPoints,
            backgroundColor: getColorByName(food),
            stack: 'total',
            yAxisID: 'y'
        };
    });

    // ğŸ”¹ å…¨ã¦0ã®æ–™ç†ã‚’é™¤å¤–
    const filteredDatasets = fullDatasets.filter(ds => ds.data.some(v => v > 0));

    // ğŸ”¹ æ—¥åˆ¥ã®ç·é‡é‡ï¼ˆæŠ˜ã‚Œç·šç”¨ï¼‰ã‚’è¨ˆç®—
    const totalLineData = labels.map(date => {
        const dayData = chartData[date];
        if (!dayData) return 0;
        return Object.values(dayData)
            .map(v => Number(v) || 0)   // âœ… æ•°å€¤ã¸å¼·åˆ¶å¤‰æ›
            .reduce((a, b) => a + b, 0);
    });

    // ğŸ”¹ æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼ˆç·é‡ãƒˆãƒ¬ãƒ³ãƒ‰ï¼‰ã‚’è¿½åŠ 
    const totalLineDataset = {
        label: 'ç·é‡é‡',
        data: totalLineData,
        type: 'line',
        borderColor: '#f472b6',
        backgroundColor: '#f472b6',
        borderWidth: 2,
        tension: 0.3,
        fill: false,
        yAxisID: 'y1' // âœ… å³å´ã®è»¸ã‚’ä½¿ç”¨
    };

    let chartType = 'bar'; // ç¾åœ¨ã®ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—

    // ğŸ”¹ Chart.js åˆæœŸåŒ–
    const ctx = document.getElementById('dailyChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [...filteredDatasets, totalLineDataset]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },

            // âœ… ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
            animation: {
                duration: 1200,
                easing: 'easeInOutCubic'
            },
            transitions: {
                show: { animations: { x: { from: 0 }, y: { from: 0 } } },
                hide: { animations: { x: { to: 0 }, y: { to: 0 } } }
            },

            scales: {
                x: {
                    stacked: true,
                    ticks: { color: '#d1d5db' },
                    grid: { color: '#374151' }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { color: '#d1d5db' },
                    grid: { color: '#374151' },
                    title: { display: true, text: 'å„æ–™ç†ã®é‡é‡ (g)', color: '#9ca3af' }
                },
                y1: {
                    position: 'right',
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#f472b6' },
                    title: { display: true, text: 'ç·é‡é‡ (g)', color: '#f472b6' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#e5e7eb' },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'ç›´è¿‘30æ—¥é–“ã®é£Ÿæé‡é‡æ¨ç§»',
                    color: '#f9fafb',
                    font: { size: 18 }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    // ğŸ’¡ æ ¸å¿ƒæ’åºé€»è¾‘
                    itemSort: function(a, b) {
                        // å¦‚æœæ˜¯æŸ±çŠ¶å›¾ï¼Œåè½¬é¡ºåºï¼ˆè®©é¡¶å±‚æŸ±å­æ’åœ¨ Tooltip æœ€ä¸Šæ–¹ï¼‰
                        if (chartType === 'bar') {
                            return b.datasetIndex - a.datasetIndex;
                        }
                        // å¦‚æœæ˜¯æŠ˜çº¿å›¾ï¼ŒæŒ‰æ•°å€¼å¤§å°é™åºæ’åˆ—ï¼ˆå¤§çš„åœ¨å‰ï¼‰
                        return b.raw - a.raw;
                    },
                    callbacks: {
                        // âœ… è¿‡æ»¤æ‰â€œæ€»é‡é‡â€æŠ˜çº¿åœ¨åˆ—è¡¨ä¸­çš„é‡å¤æ˜¾ç¤º
                        label: function (ctx) {
                            if (ctx.dataset.label === 'æ€»é‡é‡' || ctx.dataset.label === 'ç·é‡é‡') {
                                return null; // ä¸åœ¨åˆ—è¡¨ä¸­æ˜¾ç¤ºå•è¡Œæ€»é‡
                            }
                            const val = Number(ctx.parsed.y) || 0;
                            return val > 0 ? `${ctx.dataset.label}: ${val} g` : null;
                        },
                        // âœ… ç»Ÿä¸€åœ¨åº•éƒ¨æ˜¾ç¤ºâ€œåˆè®¡â€
                        afterBody: function (items) {
                            const total = items
                                .filter(i => i.dataset.label !== 'æ€»é‡é‡' && i.dataset.label !== 'ç·é‡é‡')
                                .reduce((sum, i) => sum + Number(i.parsed?.y || 0), 0);
                            return `åˆè®¡: ${total} g`;
                        }
                    }
                }
            }
        }
    });

    // ğŸ”˜ ã‚°ãƒ©ãƒ•ã‚¿ã‚¤ãƒ—åˆ‡ã‚Šæ›¿ãˆï¼ˆæ£’ã‚°ãƒ©ãƒ• â‡„ æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ï¼‰
    $('#toggleChartTypeBtn').on('click', function () {
        if (chartType === 'bar') {
            // æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã¸åˆ‡ã‚Šæ›¿ãˆ
            chartType = 'line';

            // å…¨ã¦0ã§ã¯ãªã„æ–™ç†ã®ã¿æŠ½å‡º
            const nonZeroLineDatasets = fullDatasets
                .filter(ds => ds.data.some(v => v > 0))
                .map(ds => ({
                    ...ds,
                    type: 'line',
                    fill: false,
                    borderWidth: 2,
                    borderColor: ds.backgroundColor,
                    yAxisID: 'y',
                    tension: 0.3,           // âœ… æ›²ç·šã®æ»‘ã‚‰ã‹ã•
                    pointRadius: 3,         // âœ… ãƒã‚¤ãƒ³ãƒˆã‚µã‚¤ã‚º
                    pointHoverRadius: 5
                }));

            // ãƒ‡ãƒ¼ã‚¿ã‚»ãƒƒãƒˆã‚’ç½®ãæ›ãˆï¼ˆæ–™ç†ã®æŠ˜ã‚Œç·š + ç·é‡é‡ï¼‰
            chart.data.datasets = [...nonZeroLineDatasets, totalLineDataset];
            $(this).text('æ£’ã‚°ãƒ©ãƒ•ã«åˆ‡ã‚Šæ›¿ãˆ');

            // ğŸª„ ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            chart.update({
                duration: 1000,
                easing: 'easeInOutCubic'
            });
        } else {
            // ç©ã¿ä¸Šã’æ£’ã‚°ãƒ©ãƒ•ã¸æˆ»ã™
            chartType = 'bar';

            const barDatasets = filteredDatasets.map(ds => ({
                ...ds,
                type: 'bar',
                fill: true,
                yAxisID: 'y'
            }));

            chart.data.datasets = [...barDatasets, totalLineDataset];
            $(this).text('æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•ã«åˆ‡ã‚Šæ›¿ãˆ');

            // ğŸª„ ã‚¹ãƒ ãƒ¼ã‚ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            chart.update({
                duration: 1000,
                easing: 'easeInOutCubic'
            });
        }
        chart.update();
    });
});
</script>
{% endblock %}
