{% extends "base.html" %}

{% block content %}

<div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-bold">ğŸ“Š ç›´è¿‘30æ—¥é£Ÿæç»Ÿè®¡</h1>

    <div class="space-x-2">
        <button id="toggleChartTypeBtn"
            class="bg-gray-700 hover:bg-gray-600 text-gray-100 px-4 py-2 rounded-md transition">
            åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾
        </button>
    </div>
</div>

<div class="overflow-x-auto">
    <div class="bg-gray-800 p-4 rounded-2xl shadow-md min-h-[calc(100vh-120px)]">
        <canvas id="dailyChart" class="w-full h-full"></canvas>
    </div>
</div>
{% endblock %}

{% block js %}
<script src="{{ url_for('static', filename='chart.js') }}"></script>
<script>
$(function () {
    const chartData = {{ data|default({})|tojson }};
    const allFoods = {{ foods|default([])|tojson }};
    const labels = Object.keys(chartData);
    const getColor = () => `hsl(${Math.floor(Math.random()*360)},70%,60%)`;

    // ğŸ”¹ æ„å»ºæ‰€æœ‰èœå“æ•°æ®é›†
    const fullDatasets = allFoods.map(food => {
        const dataPoints = labels.map(date => chartData[date][food] || 0);
        return {
            label: food,
            data: dataPoints,
            backgroundColor: getColor(),
            stack: 'total',
            yAxisID: 'y'
        };
    });

    // ğŸ”¹ è¿‡æ»¤æ‰å…¨ä¸º 0 çš„èœå“
    const filteredDatasets = fullDatasets.filter(ds => ds.data.some(v => v > 0));

    // ğŸ”¹ è®¡ç®—æ¯æ—¥æ€»é‡é‡æŠ˜çº¿æ•°æ®
    const totalLineData = labels.map(date => {
        const dayData = chartData[date];
        if (!dayData) return 0;
        return Object.values(dayData)
            .map(v => Number(v) || 0)   // âœ… å¼ºåˆ¶è½¬æ¢ä¸ºæ•°å­—
            .reduce((a, b) => a + b, 0);
    });

    // ğŸ”¹ æ·»åŠ æŠ˜çº¿å›¾ï¼ˆæ€»é‡è¶‹åŠ¿ï¼‰
    const totalLineDataset = {
        label: 'ç·é‡é‡',
        data: totalLineData,
        type: 'line',
        borderColor: '#f472b6',
        backgroundColor: '#f472b6',
        borderWidth: 2,
        tension: 0.3,
        fill: false,
        yAxisID: 'y1' // âœ… ä½¿ç”¨å³ä¾§è½´
    };

     let chartType = 'bar'; // å½“å‰å›¾è¡¨ç±»å‹

    // ğŸ”¹ åˆå§‹åŒ– Chart.js
    const ctx = document.getElementById('dailyChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels,
            datasets: [...filteredDatasets, totalLineDataset]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },

            // âœ… åŠ¨ç”»é…ç½®
            animation: {
                duration: 1200,
                easing: 'easeInOutCubic'
            },
            transitions: {
                show: { animations: { x: { from: 0 }, y: { from: 0 } } },
                hide: { animations: { x: { to: 0 }, y: { to: 0 } } }
            },

            scales: {
                x: {
                    stacked: true,
                    ticks: { color: '#d1d5db' },
                    grid: { color: '#374151' }
                },
                y: {
                    stacked: true,
                    beginAtZero: true,
                    ticks: { color: '#d1d5db' },
                    grid: { color: '#374151' },
                    title: { display: true, text: 'å„æ–™ç†é‡é‡(g)', color: '#9ca3af' }
                },
                y1: {
                    position: 'right',
                    beginAtZero: true,
                    grid: { drawOnChartArea: false },
                    ticks: { color: '#f472b6' },
                    title: { display: true, text: 'ç·é‡é‡(g)', color: '#f472b6' }
                }
            },
            plugins: {
                legend: {
                    labels: { color: '#e5e7eb' },
                    position: 'bottom'
                },
                title: {
                    display: true,
                    text: 'ç›´è¿‘30æ—¥é£Ÿæé‡é‡æ¨ç§»',
                    color: '#f9fafb',
                    font: { size: 18 }
                },
                tooltip: {
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        // âœ… tooltipå†…å®¹è¿‡æ»¤æ‰ä¸º0çš„èœå“ï¼Œå¹¶æ˜¾ç¤ºæ€»é‡
                        label: function (ctx) {
                            if (ctx.dataset.label === 'ç·é‡é‡') {
                                const val = Number(ctx.dataset.data[ctx.dataIndex]) || 0;
                                return `ç·é‡é‡: ${val} g`;
                            }
                            const val = Number(ctx.parsed.y) || 0;
                            return val > 0 ? `${ctx.dataset.label}: ${val} g` : null;
                        },
                        afterBody: function (items) {
                            const total = items
                                .filter(i => i.dataset.label !== 'ç·é‡é‡')
                                .reduce((sum, i) => sum + Number(i.parsed?.y || 0), 0);
                            return `åˆè¨ˆ: ${total} g`;
                        }
                    }
                }
            }
        }
    });

    // ğŸ”˜ åˆ‡æ¢å›¾è¡¨ç±»å‹ï¼ˆæŸ±å½¢ <-> æŠ˜çº¿ï¼‰
    $('#toggleChartTypeBtn').on('click', function () {
        if (chartType === 'bar') {
            // åˆ‡æ¢ä¸ºæŠ˜çº¿å›¾
            chartType = 'line';
            // è¿‡æ»¤æ‰å…¨ä¸º0çš„èœå“
            const nonZeroLineDatasets = fullDatasets
                .filter(ds => ds.data.some(v => v > 0))
                .map(ds => ({
                    ...ds,
                    type: 'line',
                    fill: false,
                    borderWidth: 2,
                    borderColor: ds.backgroundColor,
                    yAxisID: 'y',
                    tension: 0.3,           // âœ… æ›²çº¿å¹³æ»‘åº¦
                    pointRadius: 3,         // âœ… å°åœ†ç‚¹
                    pointHoverRadius: 5
                }));

            // æŠŠæ•°æ®é›†æ›¿æ¢ä¸ºï¼šéé›¶èœå“æŠ˜çº¿ + æ€»é‡é‡æŠ˜çº¿
            chart.data.datasets = [...nonZeroLineDatasets, totalLineDataset];
            
            $(this).text('æ£’ã‚°ãƒ©ãƒ•åˆ‡æ¢');

            // ğŸª„ å¹³æ»‘è¿‡æ¸¡åŠ¨ç”»
            chart.update({
                duration: 1000,
                easing: 'easeInOutCubic'
            });
        } else {
            // åˆ‡æ¢å›å †å æŸ±å½¢å›¾
            chartType = 'bar';
            const barDatasets = filteredDatasets.map(ds => ({
                ...ds,
                type: 'bar',
                fill: true,
                yAxisID: 'y'
            }));

            chart.data.datasets = [...barDatasets, totalLineDataset];
            $(this).text('æŠ˜ç·šã‚°ãƒ©ãƒ•åˆ‡æ¢');
            // ğŸª„ å¹³æ»‘è¿‡æ¸¡åŠ¨ç”»
            chart.update({
                duration: 1000,
                easing: 'easeInOutCubic'
            });
        }
        chart.update();
    });
});
</script>
{% endblock %}